generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum VenueStatus {
  DRAFT
  ACTIVE
  BLOCKED
}

enum VenueType {
  RESTAURANT
  CAFE
  BAR
  COFFEE_SHOP
  OTHER
}

enum StaffRole {
  WAITER
  BARTENDER
  BARISTA
  HOSTESS
  CHEF
  ADMINISTRATOR
  OTHER
}

enum StaffStatus {
  ACTIVE
  INACTIVE
}

enum QrType {
  // New types
  INDIVIDUAL
  TEAM
  // Legacy types (kept for backward compatibility during migration)
  PERSONAL  // @deprecated - migrated to INDIVIDUAL
  TABLE     // @deprecated - migrated to TEAM
  VENUE     // @deprecated - migrated to TEAM
}

enum QrStatus {
  ACTIVE
  INACTIVE
}

enum TipType {
  PERSONAL
  POOL
}

enum TransactionStatus {
  PENDING
  PAID
  FAILED
  CANCELED
  EXPIRED
}

enum PayoutStatus {
  PENDING
  PAID
}

enum DistributionMode {
  PERSONAL
  POOLED
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum ConnectionPurpose {
  CONNECTION
  SUPPORT
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  phone         String?   @unique
  firstName     String?
  lastName      String?
  avatarUrl     String?
  passwordHash  String?
  role          UserRole
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  managedVenues Venue[]   @relation("VenueManager")
  staffProfile  Staff?

  @@index([email])
  @@index([phone])
}

model Venue {
  id                String           @id @default(cuid())
  name              String
  type              VenueType
  address           String?
  phone             String?
  email             String?
  logoUrl           String?
  timezone          String           @default("Asia/Makassar")
  status            VenueStatus      @default(DRAFT)
  distributionMode  DistributionMode @default(PERSONAL)
  allowStaffChoice  Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  midtransMerchantId  String?
  midtransServerKey   String?
  midtransClientKey   String?
  midtransConnected   Boolean  @default(false)
  midtransEnvironment String   @default("sandbox")

  managerId String
  manager   User     @relation("VenueManager", fields: [managerId], references: [id])
  staff     Staff[]
  qrCodes   QrCode[]
  tips      Tip[]
  payouts   Payout[]
  menuCategories MenuCategory[]

  @@index([managerId])
  @@index([status])
}

model Staff {
  id                 String      @id @default(cuid())
  displayName        String
  fullName           String?
  role               StaffRole
  status             StaffStatus @default(ACTIVE)
  participatesInPool Boolean     @default(true)
  avatarUrl          String?
  balance            Int         @default(0)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  venueId     String
  venue       Venue           @relation(fields: [venueId], references: [id])
  userId      String?         @unique
  user        User?           @relation(fields: [userId], references: [id])
  
  // For INDIVIDUAL QR - direct relation
  qrCode      QrCode?         @relation("StaffQr")
  
  // For TEAM QR - many-to-many via QrCodeRecipient
  teamQrCodes QrCodeRecipient[]
  
  tips        Tip[]
  allocations TipAllocation[]

  @@index([venueId])
  @@index([status])
}

model QrCode {
  id        String   @id @default(cuid())
  type      QrType
  label     String?
  status    QrStatus @default(ACTIVE)
  shortCode String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venueId String
  venue   Venue   @relation(fields: [venueId], references: [id])
  
  // For INDIVIDUAL QR - direct staff reference
  staffId String? @unique
  staff   Staff?  @relation("StaffQr", fields: [staffId], references: [id])
  
  // For TEAM QR - many-to-many via QrCodeRecipient
  recipients QrCodeRecipient[]
  
  tips    Tip[]

  @@index([venueId])
  @@index([shortCode])
}

// Many-to-many relation for TEAM QR codes to Staff
model QrCodeRecipient {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  qrCodeId String
  qrCode   QrCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([qrCodeId, staffId])
  @@index([qrCodeId])
  @@index([staffId])
}

model Tip {
  id                      String            @id @default(cuid())
  amount                  Int
  netAmount               Int
  platformFee             Int
  guestPaidFee            Boolean           @default(false)
  type                    TipType
  status                  TransactionStatus @default(PENDING)
  midtransOrderId         String            @unique
  midtransPaymentType     String?
  midtransTransactionId   String?
  midtransTransactionTime DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt

  venueId     String
  venue       Venue           @relation(fields: [venueId], references: [id])
  qrCodeId    String
  qrCode      QrCode          @relation(fields: [qrCodeId], references: [id])
  staffId     String?
  staff       Staff?          @relation(fields: [staffId], references: [id])
  allocations TipAllocation[]

  @@index([venueId])
  @@index([status])
  @@index([createdAt])
  @@index([midtransOrderId])
}

model TipAllocation {
  id        String   @id @default(cuid())
  amount    Int
  date      DateTime @db.Date
  createdAt DateTime @default(now())

  tipId    String
  tip      Tip     @relation(fields: [tipId], references: [id])
  staffId  String
  staff    Staff   @relation(fields: [staffId], references: [id])
  payoutId String?
  payout   Payout? @relation(fields: [payoutId], references: [id])

  @@index([staffId])
  @@index([date])
  @@index([payoutId])
}

model Payout {
  id          String       @id @default(cuid())
  periodStart DateTime     @db.Date
  periodEnd   DateTime     @db.Date
  totalAmount Int
  status      PayoutStatus @default(PENDING)
  paidAt      DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  venueId     String
  venue       Venue           @relation(fields: [venueId], references: [id])
  allocations TipAllocation[]

  @@index([venueId])
  @@index([periodStart, periodEnd])
}

model OtpCode {
  id        String   @id @default(cuid())
  code      String
  phone     String?
  email     String?
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([email])
  @@index([expiresAt])
}

model WebhookLog {
  id        String   @id @default(cuid())
  provider  String
  payload   Json
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())

  @@index([provider])
  @@index([processed])
}

model ConnectionRequest {
  id           String            @id @default(cuid())
  purpose      ConnectionPurpose
  businessName String
  contactName  String
  email        String
  phone        String
  createdAt    DateTime          @default(now())

  @@index([createdAt])
  @@index([purpose])
}


// ==================== MENU ====================

model MenuCategory {
  id           String   @id @default(cuid())
  name         String
  description  String?
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  venueId      String
  venue        Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  
  parentId     String?
  parent       MenuCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     MenuCategory[] @relation("CategoryHierarchy")
  
  items        MenuItem[]

  @@unique([venueId, name])
  @@index([venueId])
  @@index([parentId])
  @@index([displayOrder])
}

model MenuItem {
  id           String   @id @default(cuid())
  name         String
  description  String?
  price        Int?
  imageUrl     String?
  isAvailable  Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  categoryId   String
  category     MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([displayOrder])
  @@index([isAvailable])
}
