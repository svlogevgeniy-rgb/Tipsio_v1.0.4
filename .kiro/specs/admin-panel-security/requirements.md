# Документ требований: Безопасность админ-панели

## Введение

Эта функция реализует комплексную аутентификацию и авторизацию для админ-панели, чтобы гарантировать, что только аутентифицированные пользователи с ролью ADMIN могут получить доступ к маршрутам админки и API endpoints. Система должна предотвращать несанкционированный доступ, корректно обрабатывать права доступа на основе ролей и избегать мигания UI-контента перед редиректами.

## Глоссарий

- **Admin_Panel**: Коллекция UI-маршрутов под `/admin/*` и API-маршрутов под `/api/admin/*`, которые предоставляют административный функционал
- **Auth_System**: Система аутентификации на основе NextAuth, использующая JWT токены и управление сессиями
- **Middleware**: Middleware Next.js, который перехватывает запросы до того, как они достигнут обработчиков маршрутов
- **ADMIN_Role**: Обозначение роли пользователя, которая предоставляет доступ к административным функциям
- **Content_Flash**: Краткое отображение защищенного UI-контента до завершения проверки аутентификации и выполнения редиректа
- **Protected_Route**: Любой маршрут, который требует аутентификации и специфической авторизации по роли
- **Session_Token**: JWT токен, содержащий информацию об идентификации пользователя и его роли

## Требования

### Требование 1: Предотвращение доступа без аутентификации

**User Story:** Как системный администратор, я хочу, чтобы все маршруты админ-панели требовали аутентификации, чтобы неавторизованные пользователи не могли получить доступ к конфиденциальным административным функциям.

#### Критерии приемки

1. КОГДА неаутентифицированный пользователь пытается получить доступ к любому маршруту `/admin/*`, ТОГДА Auth_System ДОЛЖНА перенаправить его на `/venue/login` с callback URL
2. КОГДА неаутентифицированный пользователь пытается получить доступ к любому endpoint `/api/admin/*`, ТОГДА Auth_System ДОЛЖНА вернуть статус 401 с кодом ошибки 'AUTH_REQUIRED'
3. КОГДА сессия пользователя истекает во время нахождения на странице админки, ТОГДА Auth_System ДОЛЖНА перенаправить его на страницу входа при следующем действии
4. Middleware ДОЛЖЕН проверять аутентификацию до выполнения любого обработчика маршрута админки

### Требование 2: Авторизация на основе ролей

**User Story:** Как системный администратор, я хочу, чтобы только пользователи с ролью ADMIN имели доступ к админ-панели, чтобы менеджеры заведений и персонал не могли получить доступ к административным функциям.

#### Критерии приемки

1. КОГДА аутентифицированный пользователь с ADMIN_Role обращается к любому маршруту `/admin/*`, ТОГДА Auth_System ДОЛЖНА разрешить доступ
2. КОГДА аутентифицированный пользователь без ADMIN_Role пытается получить доступ к любому маршруту `/admin/*`, ТОГДА Auth_System ДОЛЖНА перенаправить его на соответствующую панель управления
3. КОГДА аутентифицированный пользователь с ролью MANAGER пытается получить доступ к админке, ТОГДА Auth_System ДОЛЖНА перенаправить на `/venue/dashboard`
4. КОГДА аутентифицированный пользователь с ролью STAFF пытается получить доступ к админке, ТОГДА Auth_System ДОЛЖНА перенаправить на `/staff/dashboard`
5. КОГДА аутентифицированный пользователь без распознанной роли пытается получить доступ к админке, ТОГДА Auth_System ДОЛЖНА перенаправить на `/`

### Требование 3: Защита API endpoints

**User Story:** Как системный администратор, я хочу, чтобы все API endpoints админки проверяли аутентификацию и авторизацию, чтобы административные операции не могли быть выполнены через прямые вызовы API.

#### Критерии приемки

1. КОГДА любой endpoint `/api/admin/*` получает запрос, ТОГДА Auth_System ДОЛЖНА проверить, что Session_Token содержит валидную аутентификацию
2. КОГДА любой endpoint `/api/admin/*` получает запрос, ТОГДА Auth_System ДОЛЖНА проверить, что пользователь имеет ADMIN_Role
3. КОГДА API-запрос не содержит валидной аутентификации, ТОГДА Auth_System ДОЛЖНА вернуть статус 401 с сообщением 'Authentication required'
4. КОГДА API-запрос имеет валидную аутентификацию, но не имеет ADMIN_Role, ТОГДА Auth_System ДОЛЖНА вернуть статус 403 с сообщением 'Insufficient permissions'
5. Auth_System ДОЛЖНА выполнять проверки авторизации до выполнения любой бизнес-логики

### Требование 4: Предотвращение мигания контента

**User Story:** Как системный администратор, я хочу, чтобы UI-контент админки никогда не отображался неавторизованным пользователям, чтобы конфиденциальная информация не была кратковременно видна перед редиректом.

#### Критерии приемки

1. КОГДА неавторизованный пользователь обращается к маршруту админки, ТОГДА Middleware ДОЛЖЕН перехватить запрос до рендеринга любого контента страницы
2. КОГДА выполняется проверка аутентификации, ТОГДА Admin_Panel ДОЛЖНА отображать состояние загрузки вместо защищенного контента
3. КОГДА используется клиентская навигация к маршрутам админки, ТОГДА Auth_System ДОЛЖНА проверить авторизацию перед рендерингом защищенного контента
4. Admin_Panel НЕ ДОЛЖНА рендерить какие-либо конфиденциальные данные на клиенте до подтверждения авторизации

### Требование 5: Согласованная обработка ошибок

**User Story:** Как разработчик, я хочу согласованные ответы об ошибках для сбоев аутентификации, чтобы фронтенд мог обрабатывать их единообразно.

#### Критерии приемки

1. КОГДА аутентификация не удается на API endpoint, ТОГДА Auth_System ДОЛЖНА вернуть JSON со структурой `{ code: 'AUTH_REQUIRED', message: string }`
2. КОГДА авторизация не удается на API endpoint, ТОГДА Auth_System ДОЛЖНА вернуть JSON со структурой `{ code: 'FORBIDDEN', message: string }`
3. КОГДА аутентификация не удается на UI-маршруте, ТОГДА Middleware ДОЛЖЕН перенаправить с исходным URL в качестве параметра `callbackUrl`
4. Auth_System ДОЛЖНА использовать согласованные HTTP-коды статуса: 401 для сбоев аутентификации, 403 для сбоев авторизации

### Требование 6: Валидация существующей защиты

**User Story:** Как разработчик, я хочу проверить, что существующие маршруты и endpoints админки должным образом защищены, чтобы не было пробелов в безопасности в текущей реализации.

#### Критерии приемки

1. Auth_System ДОЛЖНА защищать все маршруты, соответствующие паттерну `/admin/*`
2. Auth_System ДОЛЖНА защищать все маршруты, соответствующие паттерну `/api/admin/*`
3. КОГДА проверяются существующие API endpoints админки, ТОГДА каждый ДОЛЖЕН использовать функции middleware `requireAuth()` и `requireRole()`
4. КОГДА проверяются существующие UI-страницы админки, ТОГДА Middleware ДОЛЖЕН обеспечивать аутентификацию перед загрузкой страницы

### Требование 7: Управление сессиями

**User Story:** Как системный администратор, я хочу, чтобы сессии админки управлялись безопасно, чтобы несанкционированный доступ не мог произойти через манипуляцию сессией.

#### Критерии приемки

1. Auth_System ДОЛЖНА использовать JWT токены с NEXTAUTH_SECRET для валидации сессий
2. КОГДА валидируется сессия, ТОГДА Auth_System ДОЛЖНА проверить подпись токена и срок действия
3. КОГДА токен сессии невалиден или истек, ТОГДА Auth_System ДОЛЖНА рассматривать пользователя как неаутентифицированного
4. Middleware ДОЛЖЕН извлекать информацию о сессии из JWT токенов без запросов к базе данных для производительности

### Требование 8: Тестирование и верификация

**User Story:** Как разработчик, я хочу комплексные тесты для безопасности админ-панели, чтобы я мог проверить, что защита работает корректно и предотвратить регрессии.

#### Критерии приемки

1. Auth_System ДОЛЖНА иметь тесты, проверяющие, что неаутентифицированные пользователи не могут получить доступ к маршрутам админки
2. Auth_System ДОЛЖНА иметь тесты, проверяющие, что роли, не являющиеся админами, не могут получить доступ к маршрутам админки
3. Auth_System ДОЛЖНА иметь тесты, проверяющие, что роль ADMIN может получить доступ ко всем маршрутам админки
4. Auth_System ДОЛЖНА иметь тесты, проверяющие, что API endpoints возвращают корректные коды ошибок для несанкционированного доступа
5. Auth_System ДОЛЖНА иметь тесты, проверяющие, что не происходит мигания контента при попытках несанкционированного доступа
