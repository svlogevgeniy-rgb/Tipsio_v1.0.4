# Документ проектирования

## Обзор

Задача TIPS-63 представляет собой комплексный процесс рефакторинга, коммита и деплоя приложения Tipsio версии 1.0.4+. Проект включает три основных этапа: локальный рефакторинг без изменения поведения, публикацию изменений в GitHub и развертывание на продакшн-сервере tipsio.tech.

## Архитектура

### Компоненты системы

1. **Локальная среда разработки**
   - Кодовая база Next.js приложения
   - Инструменты проверки качества (ESLint, TypeScript, Next.js build)
   - Git для контроля версий

2. **GitHub репозиторий**
   - Удаленный репозиторий: https://github.com/svlogevgeniy-rgb/Tipsio_v1.0.4
   - История коммитов
   - Ветка для деплоя

3. **Продакшн-сервер**
   - Сервер по адресу https://tipsio.tech/
   - Процесс деплоя (pull, rebuild, restart)
   - База данных PostgreSQL с миграциями Prisma

### Процесс деплоя

```mermaid
graph LR
    A[Локальный рефакторинг] --> B[Проверка качества]
    B --> C[Git commit & push]
    C --> D[SSH на сервер]
    D --> E[Git pull]
    E --> F[Применение миграций]
    F --> G[Rebuild приложения]
    G --> H[Restart сервиса]
    H --> I[Проверка работоспособности]
```

## Компоненты и интерфейсы

### 1. Модуль рефакторинга

**Ответственность**: Проведение изменений кода без изменения поведения

**Интерфейс**:
- Входные данные: Существующая кодовая база
- Выходные данные: Рефакторенный код с сохранением функциональности

**Ограничения**:
- Не изменять UI компоненты визуально
- Не изменять API контракты
- Не изменять бизнес-логику
- Не изменять переводы i18n

### 2. Модуль проверки качества

**Ответственность**: Валидация изменений перед коммитом

**Интерфейс**:
```bash
npm run lint      # ESLint проверка
npm run typecheck # TypeScript проверка
npm run build     # Next.js сборка
```

**Критерии успеха**:
- Все команды завершаются с кодом выхода 0
- Нет ошибок в выводе
- Build создает оптимизированную продакшн-сборку

### 3. Модуль Git операций

**Ответственность**: Управление версиями и публикация изменений

**Интерфейс**:
```bash
git add .
git commit -m "TIPS-63: Refactor codebase for v1.0.4+"
git push origin main
```

**Требования к коммиту**:
- Описательное сообщение с номером задачи
- Включение всех измененных файлов
- Успешный push в удаленный репозиторий

### 4. Модуль деплоя

**Ответственность**: Развертывание на продакшн-сервере

**Интерфейс**:
```bash
# На продакшн-сервере
cd /path/to/tipsio
git pull origin main
npx prisma migrate deploy  # Если есть миграции
npm run build
pm2 restart tipsio         # Или docker-compose restart
```

**Проверки после деплоя**:
- Сайт доступен по https://tipsio.tech/
- /api/health возвращает 200 OK
- Основные страницы загружаются без ошибок

## Модели данных

### Конфигурация деплоя

```typescript
interface DeploymentConfig {
  repository: string;           // URL репозитория
  branch: string;               // Ветка для деплоя
  serverPath: string;           // Путь на сервере
  buildCommand: string;         // Команда сборки
  restartCommand: string;       // Команда перезапуска
  healthCheckUrl: string;       // URL для проверки
  requiresMigrations: boolean;  // Нужны ли миграции
}
```

### Результат проверки качества

```typescript
interface QualityCheckResult {
  lint: {
    passed: boolean;
    errors: string[];
  };
  typecheck: {
    passed: boolean;
    errors: string[];
  };
  build: {
    passed: boolean;
    errors: string[];
  };
  allPassed: boolean;
}
```

## Свойства корректности

*Свойство — это характеристика или поведение, которое должно выполняться во всех допустимых выполнениях системы. По сути, это формальное утверждение о том, что должна делать система. Свойства служат мостом между человекочитаемыми спецификациями и машинно-проверяемыми гарантиями корректности.*

### Свойство 1: Сохранение функциональности после рефакторинга

*Для любого* рефакторинга кода, все существующие тесты должны продолжать проходить успешно, что подтверждает сохранение функциональности.

**Валидирует: Требования 1.1, 1.2, 1.3, 1.4**

### Свойство 2: Успешность процесса сборки

*Для любого* набора изменений, процесс сборки (lint + typecheck + build) должен завершаться без ошибок перед коммитом.

**Валидирует: Требования 1.5, 1.6, 1.7**

### Свойство 3: Синхронизация репозитория

*Для любого* коммита, после успешного push в GitHub, удаленный репозиторий должен содержать все локальные изменения.

**Валидирует: Требования 2.1, 2.2, 2.3**

### Свойство 4: Доступность после деплоя

*Для любого* успешного деплоя, продакшн-сервер должен быть доступен и health check должен возвращать успешный статус.

**Валидирует: Требования 3.5, 3.6, 4.1, 4.3**

### Свойство 5: Идемпотентность деплоя

*Для любого* состояния кода, повторный деплой той же версии должен приводить к идентичному состоянию сервера.

**Валидирует: Требования 3.1, 3.2, 3.3**

## Обработка ошибок

### Ошибки рефакторинга

- **Проблема**: Тесты падают после рефакторинга
- **Решение**: Откатить изменения, проанализировать причину, исправить код
- **Предотвращение**: Запускать тесты после каждого значительного изменения

### Ошибки сборки

- **Проблема**: Lint/typecheck/build завершаются с ошибками
- **Решение**: Исправить все ошибки перед коммитом
- **Предотвращение**: Использовать pre-commit hooks для автоматической проверки

### Ошибки Git операций

- **Проблема**: Конфликты при push
- **Решение**: Выполнить git pull, разрешить конфликты, повторить push
- **Предотвращение**: Синхронизироваться с удаленным репозиторием перед началом работы

### Ошибки деплоя

- **Проблема**: Сервер недоступен после деплоя
- **Решение**: 
  1. Проверить логи приложения
  2. Проверить статус процесса (pm2 logs / docker logs)
  3. При необходимости откатиться к предыдущей версии
- **Предотвращение**: Тестировать деплой на staging окружении

### Ошибки миграций

- **Проблема**: Миграции базы данных не применяются
- **Решение**:
  1. Проверить подключение к базе данных
  2. Проверить права доступа
  3. Применить миграции вручную с логированием
- **Предотвращение**: Тестировать миграции на копии продакшн базы

## Стратегия тестирования

### Unit тесты

- Запустить существующие unit тесты для проверки сохранения функциональности
- Команда: `npm test`
- Все тесты должны проходить успешно

### Property-based тесты

- Запустить существующие property-based тесты
- Проверить, что свойства системы сохранены после рефакторинга
- Минимум 100 итераций на тест

### Интеграционные тесты

- Проверить работу API эндпоинтов
- Проверить взаимодействие с базой данных
- Проверить работу аутентификации

### E2E тесты (ручные)

После деплоя на продакшн:
1. Открыть главную страницу https://tipsio.tech/
2. Проверить /api/health эндпоинт
3. Проверить основные пользовательские сценарии:
   - Регистрация/вход venue
   - Создание QR кода
   - Процесс оплаты чаевых
   - Просмотр дашборда

### Проверка качества кода

```bash
# Перед коммитом обязательно выполнить:
npm run lint      # Должно пройти без ошибок
npm run typecheck # Должно пройти без ошибок
npm run build     # Должно пройти без ошибок
```

### Smoke тесты на продакшне

После деплоя:
```bash
# Проверка доступности
curl https://tipsio.tech/

# Проверка health check
curl https://tipsio.tech/api/health

# Ожидаемый результат: 200 OK
```
