# TIPS-56: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —á–∞–µ–≤—ã—Ö - –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω

**–î–∞—Ç–∞:** 5 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í—Ä–µ–º—è:** ~16:00 UTC+8  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –Ω–∞ production

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã ‚úÖ
- –ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ production —Å–µ—Ä–≤–µ—Ä—É (root@31.130.155.71)
- –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞ TestMid@gmail.com
- –û–±–Ω–∞—Ä—É–∂–∏–ª–∏, —á—Ç–æ –±–∞–ª–∞–Ω—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ = 0, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —á–∞–µ–≤—ã–µ
- –í—ã—è–≤–∏–ª–∏ root cause: —Ñ—É–Ω–∫—Ü–∏—è `allocateTip()` –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞ `Staff.balance`

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ ‚úÖ
**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `src/app/api/webhook/midtrans/route.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- `src/app/api/tips/[orderId]/route.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- `src/components/venue/qr-codes/CreateQrDialog.tsx` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω useEffect
- `src/components/venue/qr-codes/EditTeamQrDialog.tsx` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω useEffect

**–ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
```typescript
// –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
await prisma.$transaction([
  // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
  prisma.tipAllocation.create({ ... }),
  // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  prisma.staff.update({
    where: { id: staffId },
    data: {
      balance: { increment: amount }
    }
  })
]);
```

### 3. –î–µ–ø–ª–æ–π –Ω–∞ production ‚úÖ

**–ö–æ–º–º–∏—Ç—ã:**
- `5e9f39c` - fix(tips): update staff balance when allocating tips (TIPS-56)
- `f67776b` - fix: update migration script to use shared prisma instance
- `ce10fc0` - fix: add dotenv loading to migration script

**–ö–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**
```bash
# 1. Push –∫–æ–¥–∞
git push tipsio_v104 main

# 2. Pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/tipsio && git pull origin main

# 3. Build
npm run build  # ‚úÖ –£—Å–ø–µ—à–Ω–æ

# 4. Restart –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 restart tipsio && pm2 save  # ‚úÖ –£—Å–ø–µ—à–Ω–æ
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö ‚úÖ

**SQL –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω:**
```sql
UPDATE "Staff" s
SET balance = COALESCE(
  (SELECT SUM(ta.amount)
   FROM "TipAllocation" ta
   WHERE ta."staffId" = s.id
   AND ta."payoutId" IS NULL),
  0
)
WHERE s."venueId" = 'cml7t8jaf000146v36zp19nhh';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
- Admin: 0 ‚Üí 95,000 IDR
- Waiter: 0 ‚Üí 142,500 IDR

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
 displayName | balance | tips_count 
-------------+---------+------------
 Admin       |       0 |          1
 Waiter      |       0 |          1
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
 displayName | balance | unpaid_tips 
-------------+---------+-------------
 Admin       |   95000 |           1
 Waiter      |  142500 |           1
```

## ‚úÖ Acceptance Criteria

- [x] –ë–∞–ª–∞–Ω—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞–µ–≤—ã—Ö
- [x] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [x] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ production
- [x] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/venue/payouts` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã

## üîó –°—Å—ã–ª–∫–∏

- **Production URL:** https://tipsio.tech/venue/payouts
- **Venue:** TestMid (cml7t8jaf000146v36zp19nhh)
- **Manager:** TestMid@gmail.com
- **Issue Report:** `.kiro/specs/tips-balance-fix/ISSUE_REPORT.md`

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è TestMid@gmail.com:
1. –í–æ–π—Ç–∏ –Ω–∞ https://tipsio.tech/venue/login
2. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–í—ã–ø–ª–∞—Ç—ã"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–∞–ª–∞–Ω—Å—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
   - Admin: 95,000 IDR
   - Waiter: 142,500 IDR
4. –ö–Ω–æ–ø–∫–∏ "–í—ã–ø–ª–∞—á–µ–Ω–æ" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã

### –î–ª—è –Ω–æ–≤—ã—Ö —á–∞–µ–≤—ã—Ö:
- –í—Å–µ –Ω–æ–≤—ã–µ —á–∞–µ–≤—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞

## üéâ –ò—Ç–æ–≥

–ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º —á–∞–µ–≤—ã—Ö **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**:
- ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –ù–æ–≤—ã–µ —á–∞–µ–≤—ã–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–ø–ª–∞—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–û–±—â–∞—è —Å—É–º–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤:** 237,500 IDR
